## TextVRAM
80桁 x 60行 ASCIIテキスト表示の TextVRAM + コントローラ のシンプルな実装です。  
カラー表示もできます。  
ただしVGA(640x480)画像サイズですが、グラフィック機能はありません。  
  
使い方は、後述のメモリVRAM領域のアドレスに、ASCIIコードと、Red、Green、Blueの色情報を1byte書き込むだけです（デフォルトは白:RGB(0xFF,0xFF,0xFF）。


## 他FPGAへの移植について
GOWINのFPGA搭載したSipeedの[Tang Nano 9K](https://wiki.sipeed.com/hardware/en/tang/Tang-Nano-9K/Nano-9K.html) 向けに作成していますが、AMD(Xilinx)などの他のFPGAへ移植するには、HDMI(DVI)のTX出力のIPを他FPGAベンダーのIPに置き換えれば可能かと思います。  
あとVRAM本体は (* ram_style = "block" *) 指定付きでreg変数で定義していますが、非同期に対応したDualPort RAMがあれば問題ないと思います。  


# Text VRAM コントローラ 仕様書

## 1. 概要

本モジュールは、VGA信号出力に対応したテキストVRAMコントローラである。CPUからASCII文字コードおよびRGB色情報をVRAMに書き込み、VGAタイミングに同期してフォントROMを参照しながら、文字をピクセルデータとして出力する。

### 1.1 主要機能

- VGA 640x480 @60Hz タイミング信号生成
- 80桁 x 60行 テキスト表示
- 8x8ピクセル ASCIIフォント (0x20-0x7A)
- 文字ごとの24bit RGB前景色指定
- デュアルポートBRAMによるCPU/表示間の非同期アクセス
- 3段パイプラインによるタイミング調整

## 2. モジュール階層

```
text_vram_top               トップモジュール
├── vga_timing              VGAタイミングジェネレータ
├── text_vram               デュアルポートテキストVRAM
└── font_rom                8x8 ASCIIフォントROM
```

## 3. モジュール仕様

---

### 3.1 text_vram_top (トップモジュール)

#### 3.1.1 パラメータ

| パラメータ       | デフォルト値 | 説明                         |
|-----------------|-------------|------------------------------|
| H_ACTIVE        | 640         | 水平アクティブピクセル数       |
| H_FRONT_PORCH   | 16          | 水平フロントポーチ (pixel)    |
| H_SYNC_PULSE    | 96          | 水平同期パルス幅 (pixel)      |
| H_BACK_PORCH    | 48          | 水平バックポーチ (pixel)      |
| V_ACTIVE        | 480         | 垂直アクティブライン数         |
| V_FRONT_PORCH   | 10          | 垂直フロントポーチ (line)     |
| V_SYNC_PULSE    | 2           | 垂直同期パルス幅 (line)       |
| V_BACK_PORCH    | 33          | 垂直バックポーチ (line)       |
| H_SYNC_POL      | 0           | 水平同期極性 (0:負, 1:正)     |
| V_SYNC_POL      | 0           | 垂直同期極性 (0:負, 1:正)     |
| CHAR_WIDTH      | 8           | 文字幅 (pixel)                |
| CHAR_HEIGHT     | 8           | 文字高さ (pixel)              |
| COLS            | 80          | 画面横文字数 (H_ACTIVE/CHAR_WIDTH)  |
| ROWS            | 60          | 画面縦文字数 (V_ACTIVE/CHAR_HEIGHT) |
| ADDR_WIDTH      | 15          | アドレスバス幅 (log2(COLS*ROWS*4))  |

#### 3.1.2 ポート一覧

| ポート名      | 方向   | 幅       | 説明                              |
|--------------|--------|----------|-----------------------------------|
| pixel_clk    | input  | 1        | ピクセルクロック (25.175MHz for VGA) |
| rst_n        | input  | 1        | アクティブLowリセット               |
| hsync        | output | 1        | 水平同期信号                       |
| vsync        | output | 1        | 垂直同期信号                       |
| pixel_en     | output | 1        | ピクセルデータ有効信号              |
| pixel_data   | output | 1        | モノクロピクセル出力 (1:前景, 0:背景) |
| pixel_r      | output | 8        | ピクセル Red チャネル (0-255)      |
| pixel_g      | output | 8        | ピクセル Green チャネル (0-255)    |
| pixel_b      | output | 8        | ピクセル Blue チャネル (0-255)     |
| cpu_clk      | input  | 1        | CPUクロック                        |
| cpu_we       | input  | 1        | CPU書き込みイネーブル               |
| cpu_addr     | input  | ADDR_WIDTH | CPUアドレス                       |
| cpu_wdata    | input  | 8        | CPU書き込みデータ                   |
| cpu_rdata    | output | 8        | CPU読み出しデータ                   |

#### 3.1.3 パイプライン構成

ピクセル座標からピクセル出力まで3段パイプラインで処理される。

```
Stage 0 : pixel_x/y からVRAMアドレス算出 → VRAMリード要求
Stage 1 : VRAMリードデータ(char_code)取得 → フォントROMリード要求
Stage 2 : フォントROMデータ取得 → ピクセルビット選択・色データラッチ
Stage 3 : 出力レジスタ (hsync, vsync, pixel_en, pixel_data, pixel_r/g/b)
```

合計レイテンシ: **3クロックサイクル** (pixel_clk基準)

hsync, vsync, pixel_en はパイプラインと同段数遅延させて位相を合わせている。

#### 3.1.4 ピクセル出力仕様

- フォントデータのビットが1の場合: pixel_data=1, pixel_r/g/b = VRAMに格納されたRGB値
- フォントデータのビットが0の場合: pixel_data=0, pixel_r/g/b = 0x00 (黒=背景色)
- フォントデータはMSBファースト (bit7 = 最左ピクセル)

---

### 3.2 vga_timing (VGAタイミングジェネレータ)

#### 3.2.1 機能

水平/垂直カウンタを用いて、VGA規格に準拠したHSYNC/VSYNC/pixel_en信号を生成する。

#### 3.2.2 パラメータ

text_vram_topと同一のタイミングパラメータを使用。

#### 3.2.3 ポート一覧

| ポート名   | 方向   | 幅   | 説明                         |
|-----------|--------|------|------------------------------|
| clk       | input  | 1    | ピクセルクロック               |
| rst_n     | input  | 1    | アクティブLowリセット          |
| hsync     | output | 1    | 水平同期信号 (レジスタ出力)    |
| vsync     | output | 1    | 垂直同期信号 (レジスタ出力)    |
| pixel_en  | output | 1    | 表示有効エリア (組み合わせ出力) |
| pixel_x   | output | 12   | ピクセルX座標 (=水平カウンタ値) |
| pixel_y   | output | 12   | ピクセルY座標 (=垂直カウンタ値) |

#### 3.2.4 タイミングチャート (VGA 640x480 @60Hz)

```
水平タイミング (1ライン = 800 pixel clocks):
 |<--- 640 --->|<16>|<- 96 ->|<- 48 ->|
 |   Active    | FP |  Sync  |   BP   |
 |             |    |________|        |

垂直タイミング (1フレーム = 525 lines):
 |<--- 480 --->|<10>|<2>|<- 33 ->|
 |   Active    | FP |Syn|   BP   |
```

- 水平合計: 640 + 16 + 96 + 48 = **800 pixel clocks**
- 垂直合計: 480 + 10 + 2 + 33 = **525 lines**
- フレームレート: 25.175MHz / (800 x 525) = **59.94Hz**

#### 3.2.5 同期信号極性

- H_SYNC_POL=0 の場合、アクティブ区間外でLow (負極性、VGA標準)
- V_SYNC_POL=0 の場合、アクティブ区間外でLow (負極性、VGA標準)

---

### 3.3 text_vram (テキストVRAM)

#### 3.3.1 機能

文字コードおよびRGB色情報を格納するデュアルポートBRAMモジュール。表示側(リードオンリー)とCPU側(リード/ライト)で独立にアクセス可能。

#### 3.3.2 メモリマップ

アドレス空間は4ページ構成で、各ページのサイズは **COLS x ROWS = 4,800バイト** (デフォルト)。

```
アドレス範囲           ページ     内容
──────────────────────────────────────────
0x0000 - 0x12BF       Page 0     文字コード (ASCII)
0x12C0 - 0x257F       Page 1     Red   (0-255)
0x2580 - 0x383F       Page 2     Green (0-255)
0x3840 - 0x4AFF       Page 3     Blue  (0-255)
```

合計メモリサイズ: 4,800 x 4 = **19,200バイト**

#### 3.3.3 ページ内アドレス算出

各ページ内のオフセットアドレスは以下で算出される:

```
offset = row * COLS + col
```

例: 5行目 10列目の文字コード → 5 * 80 + 10 = 410 (0x019A)
例: 5行目 10列目のRed値     → 4800 + 410 = 5210 (0x145A)

#### 3.3.4 ポート一覧

| ポート名    | 方向   | 幅         | 説明                      |
|------------|--------|-----------|---------------------------|
| clk        | input  | 1         | 表示側クロック (pixel_clk)  |
| vram_addr  | input  | ADDR_WIDTH | 表示側アドレス             |
| vram_data  | output | 8         | 文字コード読み出し (1clk遅延) |
| r          | output | 8         | Red読み出し (1clk遅延)      |
| g          | output | 8         | Green読み出し (1clk遅延)    |
| b          | output | 8         | Blue読み出し (1clk遅延)     |
| cpu_clk    | input  | 1         | CPU側クロック              |
| cpu_we     | input  | 1         | CPU書き込みイネーブル       |
| cpu_addr   | input  | ADDR_WIDTH | CPUアドレス (ページ込み)   |
| cpu_wdata  | input  | 8         | CPU書き込みデータ           |
| cpu_rdata  | output | 8         | CPU読み出しデータ (組み合わせ) |

#### 3.3.5 表示ポート動作

- `clk` の立ち上がりエッジで `vram_addr` を用いて同期リード
- `vram_addr` は Page 0 (文字コード) のアドレスとして使用される
- 同一アドレスのオフセットで、Page 1/2/3 (R/G/B) も同時に読み出す
- 出力レイテンシ: **1クロックサイクル**

#### 3.3.6 CPUポート動作

- **書き込み**: `cpu_clk` の立ち上がりエッジで、`cpu_we`=1 のとき `cpu_addr` で指定されたページのメモリに `cpu_wdata` を書き込む
- **読み出し**: 組み合わせ回路による非同期リード。`cpu_addr` に応じたページのデータを即座に出力する
- アドレスデコーダにより、`cpu_addr` の範囲からアクセス先ページを自動判別する

#### 3.3.7 初期値

| ページ  | 初期値   | 説明                    |
|---------|---------|------------------------|
| Page 0  | 0x20    | スペース文字 (空白表示)  |
| Page 1  | 0xFF    | Red = 255 (白色)        |
| Page 2  | 0xFF    | Green = 255 (白色)      |
| Page 3  | 0xFF    | Blue = 255 (白色)       |

初期状態では全画面が白色のスペース文字 (実質空白) で埋められている。

#### 3.3.8 BRAM実装

`(* ram_style = "block" *)` 属性によりFPGAのBlock RAMへの推論を指示。文字コード/R/G/Bの4面は独立したBRAMとして実装される。

---

### 3.4 font_rom (フォントROM)

#### 3.4.1 機能

7bit ASCIIコード (0x00-0x7F) と文字内行番号 (0-7) から、8ピクセル分のフォントビットマップデータを出力する。

#### 3.4.2 ポート一覧

| ポート名    | 方向   | 幅  | 説明                          |
|------------|--------|-----|-------------------------------|
| clk        | input  | 1   | クロック                       |
| char_code  | input  | 7   | ASCIIコード (0x00-0x7F)       |
| row        | input  | 3   | 文字内行番号 (0-7)             |
| font_data  | output | 8   | フォントビットマップ (1clk遅延) |

#### 3.4.3 フォントROM構成

- サイズ: 128文字 x 8行 = **1,024エントリ** (各8bit)
- アドレス: `{char_code[6:0], row[2:0]}` (10bit)
- ビット配置: **MSBファースト** (bit7が最左ピクセル)
- 出力レイテンシ: **1クロックサイクル**

#### 3.4.4 収録文字

| 範囲         | 内容                              |
|-------------|-----------------------------------|
| 0x20        | スペース                           |
| 0x21-0x23   | ! " #                             |
| 0x27-0x2F   | ' ( ) * + , - . /                 |
| 0x30-0x39   | 数字 0-9                          |
| 0x3A-0x3B   | : ;                               |
| 0x3D        | =                                 |
| 0x3F-0x40   | ? @                               |
| 0x41-0x5A   | 大文字 A-Z                         |
| 0x5B, 0x5D  | [ ]                               |
| 0x5F        | _                                 |
| 0x61-0x7A   | 小文字 a-z                         |

未定義コードの出力は全ビット0 (空白) となる。

---

## 4. CPU書き込み手順

CPUからテキストVRAMに文字を表示する手順:

### 4.1 文字コード書き込み

```
1. cpu_addr に表示位置のアドレスを設定 (row * 80 + col)
2. cpu_wdata にASCIIコードを設定
3. cpu_we を1にアサート
4. cpu_clk の立ち上がりで書き込み実行
5. cpu_we を0にデアサート
```

### 4.2 文字色の設定

```
Red:   cpu_addr = 4800 + (row * 80 + col)
Green: cpu_addr = 9600 + (row * 80 + col)
Blue:  cpu_addr = 14400 + (row * 80 + col)
```

### 4.3 使用例

位置 (0, 0) に赤色の "A" を表示する場合:

```
// 文字コード書き込み
cpu_addr = 0;      cpu_wdata = 8'h41;  cpu_we = 1;  // 'A'

// 色設定 (赤 = R:0xFF, G:0x00, B:0x00)
cpu_addr = 4800;   cpu_wdata = 8'hFF;  cpu_we = 1;  // Red
cpu_addr = 9600;   cpu_wdata = 8'h00;  cpu_we = 1;  // Green
cpu_addr = 14400;  cpu_wdata = 8'h00;  cpu_we = 1;  // Blue
```

---

## 5. タイミング制約

| 項目                   | 値                      |
|-----------------------|-------------------------|
| ピクセルクロック周波数   | 25.175 MHz (VGA標準)    |
| ピクセルクロック周期     | 39.72 ns                |
| CPUクロック             | 任意 (非同期動作)        |
| VRAMリードレイテンシ     | 1 clock (pixel_clk)     |
| フォントROMリードレイテンシ | 1 clock (pixel_clk)  |
| 入力→出力レイテンシ     | 3 clocks (pixel_clk)    |

---

## 6. リソース概算

| リソース             | 概算数量                      |
|---------------------|-------------------------------|
| Block RAM (VRAM)    | 4面 x 4,800 x 8bit = 153.6Kbit |
| Block RAM (Font)    | 1,024 x 8bit = 8Kbit          |
| フリップフロップ     | ~100 (カウンタ+パイプライン)    |
| LUT                 | ~200 (アドレス演算+デコード)    |

---

## 7. ファイル構成

```
TextVRAM/
├── rtl/
│   ├── text_vram_top.v    # トップモジュール
│   ├── text_vram.v        # テキストVRAM (デュアルポートBRAM)
│   ├── vga_timing.v       # VGAタイミングジェネレータ
│   └── font_rom.v         # 8x8 ASCIIフォントROM
├── bench/
│   └── tb_text_vram.v     # テストベンチ
└── Makefile               # シミュレーション用 (iverilog/vvp/gtkwave)
```

---

## 8. シミュレーション

```bash
make sim       # コンパイル & シミュレーション実行
make wave      # 波形ビューア (GTKWave) 起動
make clean     # 生成ファイル削除
```

テストベンチでは以下を検証:
- "Hello World!" を (0, 0) に書き込み
- "FPGA" を (0, 1) に書き込み
- "0123456789" を (0, 2) に書き込み
- 3フレーム分のVGA出力を確認

---

## 9. 制限事項・注意点

1. **背景色**: 固定で黒 (0x00, 0x00, 0x00)。背景色のカスタマイズは非対応。
2. **CPUリード**: 組み合わせ回路による非同期リードのため、BRAMの同期リードポートを使用しない。合成ツールによってはDistributed RAMに推論される可能性がある。
3. **クロックドメイン交差**: CPU側とピクセル側で独立したクロックを使用するが、明示的なCDC (Clock Domain Crossing) 回路は実装されていない。CPUクロックとピクセルクロックが同一の場合は問題ないが、異なる場合はメタステーブルのリスクがある。
4. **フォント**: 収録文字はASCII印字可能文字の一部のみ。全ASCII (0x20-0x7E) をカバーしていない文字がある (例: `$`, `%`, `&`, `\`, `^`, `{`, `|`, `}`, `~`)。
